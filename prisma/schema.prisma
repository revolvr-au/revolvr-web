datasource db {
  provider = "postgresql"
  schemas  = ["public", "auth"]
}

generator client {
  provider = "prisma-client-js"
}

model Post {
  id        String   @id @default(uuid())
  userEmail String
  imageUrl  String
  mediaType String   @default("image") // "image" | "video"
  caption   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Like Like[]

  @@schema("public")
}

model StripeEvent {
  id        String   @id
  createdAt DateTime @default(now())

  @@schema("public")
}

model Like {
  id        String   @id @default(uuid())
  postId    String
  userEmail String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])

  @@unique([postId, userEmail])
  @@schema("public")
}

model RevolvrItem {
  id        String        @id @default(uuid())
  name      String
  notes     String?
  status    RevolvrStatus @default(NEW)
  value     Int?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@schema("public")
}

enum RevolvrStatus {
  NEW
  ACTIVE
  WON
  LOST

  @@schema("public")
}

model UserCredits {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  email     String   @unique
  boosts    Int      @default(0)
  tips      Int      @default(0)
  spins     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

// --- Creator onboarding + earnings (minimal, launch-safe) ---

enum CreatorStatus {
  ACTIVE
  DISABLED

  @@schema("public")
}

enum SupportKind {
  TIP
  BOOST
  SPIN
  REACTION
  VOTE

  @@schema("public")
}

enum SupportSource {
  FEED
  LIVE

  @@schema("public")
}

model CreatorProfile {
  id          String        @id @default(cuid())
  email       String        @unique
  displayName String
  handle      String?       @unique
  payoutShare Int           @default(45)
  status      CreatorStatus @default(ACTIVE)

  creatorTermsAccepted   Boolean   @default(false) @map("creator_terms_accepted")
  creatorTermsAcceptedAt DateTime? @map("creator_terms_accepted_at")
  creatorTermsVersion    String?   @map("creator_terms_version")


  // Stripe Connect (Express)
  stripeAccountId        String? @map("stripe_account_id")
  stripeOnboardingStatus String  @default("not_started") @map("stripe_onboarding_status")
  payoutCurrency         String  @default("aud") @map("payout_currency")
  stripeChargesEnabled   Boolean @default(false) @map("stripe_charges_enabled")
  stripePayoutsEnabled   Boolean @default(false) @map("stripe_payouts_enabled")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Blue tick verification (recurring entitlement)
  isVerified                   Boolean   @default(false) @map("is_verified")
  verifiedSince                DateTime? @map("verified_since")
  stripeCustomerId             String?   @map("stripe_customer_id")
  stripeSubscriptionId         String?   @unique @map("stripe_subscription_id")
  verificationPriceId          String?   @map("verification_price_id")
  verificationStatus           String    @default("inactive") @map("verification_status")
  verificationCurrentPeriodEnd DateTime? @map("verification_current_period_end")

  @@schema("public")
}

model CreatorBalance {
  creatorEmail     String   @id
  totalEarnedCents Int      @default(0)
  availableCents   Int      @default(0)
  updatedAt        DateTime @updatedAt

  @@schema("public")
}

model SupportLedger {
  id String @id @default(cuid())

  creatorEmail String
  viewerEmail  String?
  kind         SupportKind
  source       SupportSource
  targetId     String?
  units        Int           @default(1)

  currency      String @default("AUD")
  grossCents    Int    @default(0)
  creatorCents  Int    @default(0)
  platformCents Int    @default(0)

  createdAt DateTime @default(now())

  @@index([creatorEmail])
  @@index([viewerEmail])
  @@index([targetId])
  @@schema("public")
}

model Payment {
  // Option B: Use Stripe Checkout Session ID as the primary key (cs_...)
  id String @id

  stripeEventId         String   @unique
  stripePaymentIntentId String
  stripeSessionId       String?
  creatorId             String
  sessionId             String?
  type                  String
  amountGross           Int
  amountCreator         Int
  amountPlatform        Int
  currency              String
  status                String // completed | refunded | failed
  createdAt             DateTime @default(now())

  @@schema("public")
}

model CreatorPayout {
  id               String   @id @default(uuid())
  creatorId        String
  amount           Int
  stripeTransferId String
  status           String // pending | completed | failed
  createdAt        DateTime @default(now())

  @@schema("public")
}

model StripeCheckoutReceipt {
  id            String   @id @default(cuid()) @db.Text
  sessionId     String   @unique @map("session_id") @db.Text
  paymentIntent String?  @map("payment_intent") @db.Text
  eventId       String?  @map("event_id") @db.Text
  livemode      Boolean  @default(false)
  amountTotal   Int?     @map("amount_total")
  currency      String?  @db.Text
  status        String?  @db.Text
  paymentStatus String?  @map("payment_status") @db.Text
  customerEmail String?  @map("customer_email") @db.Text
  metadata      Json?
  raw           Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([paymentIntent])
  @@index([customerEmail])
  @@index([createdAt])
  @@map("stripe_checkout_receipts")
  @@schema("public")
}

model Tip {
  id          String   @id @default(cuid())
  postId      String
  fromUserId  String
  toUserId    String
  amountCents Int
  createdAt   DateTime @default(now())

  @@index([postId])
  @@index([toUserId])
  @@schema("public") // <-- match whatever schema your other models use
}


// -----------------------------------------------------------------------------
// Account lifecycle + policy acceptance + safety ops (Revolvr)
// -----------------------------------------------------------------------------
model AccountState {
  email              String   @id
  status             String   @default("ACTIVE") // ACTIVE | DEACTIVATED | DELETED
  deactivatedAt      DateTime?
  deactivationReason String?
  deactivationFeedback String?
  reactivatedAt      DateTime?
  deletedAt          DateTime?
  deletionReason     String?
  deletionFeedback   String?

  termsVersion       String?
  termsAcceptedAt    DateTime?
  privacyVersion     String?
  privacyAcceptedAt  DateTime?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  @@schema("public")
}

model AccountEvent {
  id        String   @id @default(cuid())
  email     String
  type      String   // DEACTIVATE | REACTIVATE | DELETE | ACCEPT_TERMS | ACCEPT_PRIVACY | REPORT_SUBMITTED
  reason    String?
  metadata  Json?
  createdAt DateTime @default(now())
  @@schema("public")
}

model SafetyReport {
  id           String   @id @default(cuid())
  reporterEmail String?
  category     String
  link         String?
  details      String?
  status       String   @default("OPEN") // OPEN | REVIEWING | CLOSED
  createdAt    DateTime @default(now())
  @@schema("public")
}
